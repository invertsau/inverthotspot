---
title: "Spatial bias"
author: "Josh Nitschke"
date: "2024-04-06"
output: 
  rmdformats::downcute:
    self_contained: true
    toc_depth: 3
editor_options: 
  chunk_output_type: console
---

<style>
#toc ul.nav li ul li {
    display: none;
    max-height: none;
}

#toc ul.nav li.active ul li  {
    display: block;
    max-height: none;
}

#toc ul.nav li ul li ul li {
    max-height: none;
    display: none !important;
}

#toc ul.nav li ul li.active ul li {
    max-height: none;
    display: block !important;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loadpackages, include=FALSE}
## Setting up

# install.packages("pacman")
pacman::p_load(galah, arrow, here, tidyverse, janitor, ozmaps, sf, ggplot2, wesanderson, dplyr, DT, sampbias, viridis, rnaturalearthdata, remotes, terra)

require(devtools)
#gitcreds::gitcreds_delete()
install_github(repo = "azizka/sampbias")

# Load helper functions
source(here("R/utils.R"))

## Read in parquet
myg_spiders_all <- read_parquet(here(get_latest_cleaned_data()[2]))

## Subset columns we want for ALA data overview
myg_spiders_spatial_bias <- myg_spiders_all |> 
  dplyr::select(species, decimalLongitude, decimalLatitude) |>
  as.data.frame() 
  #sf::st_as_sf(coords = c("decimalLongitude", "decimalLatitude"), crs = "EPSG:4326") 
  #sf::st_transform(crs = "EPSG:9473") #projecting to Albers Equal Area projection (EPSG:9473 (GDA2020 / Australian Albers))

# myg_spiders_spatial_bias_df <- data.frame(myg_spiders_spatial_bias[,1],
#                                           sf::st_coordinates(myg_spiders_spatial_bias)) |>
#   dplyr::select(-geometry)
```

# Spatial sampling bias for Mygalomorphae

Making a map of Australia

```{r}
# map of Australia with states
aus <- st_transform(ozmaps::ozmap_states, "EPSG:4326")

## check map
ggplot(aus) + geom_sf(fill = "transparent")
```

modelling spatial sampling bias

```{r}
job::job(
  {
    model_bias_myg <- sampbias::calculate_bias(
  x = myg_spiders_spatial_bias,
  res = 0.05,   # scale of spatial resolution
  buffer = 0.5, # account for neighbouring features
  restrict_sample = sf:::as_Spatial(aus)
  )
    
  # Project the bias effect in space
model_bias_myg_proj <- sampbias::project_bias(model_bias_myg)

# Map
png("output/sampling_bias/bias_map.png", width = 2000, height = 1500, res = 300)
bias_map <- sampbias::map_bias(model_bias_myg_proj, type="sampling_rate")
dev.off()
  
  saveRDS(model_bias_myg, "output/sampling_bias/sampbias_mygals.rds")
  saveRDS(bias_map, "output/sampling_bias/samp_bias_map.rds")
  }
)
```

trying eqal-area workflow from sampbias vignette
```{r}
#loading a text file to R
occ <- read.csv(system.file("extdata",
"mammals_borneo.csv",
package = "sampbias"),
sep = "\t")

cit <- terra::vect(system.file("extdata/Borneo_major_cities.shp",
package = "sampbias"))
roa <- terra::vect(system.file("extdata/Borneo_major_roads.shp",
package = "sampbias"))
gazetteers <- list(cities = cit,
roads = roa)


# an example for an equal area raster
#projection
wgs84 <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"

data(ea_raster)
ea_raster <- terra::unwrap(ea_raster)
# reproject the occurrence coordinates
## select coordinates from the occ data.frame and create spatial object
ea_occ <- terra::vect(occ, geom = c("decimalLongitude", "decimalLatitude"),
crs="+proj=longlat +datum=WGS84")
## transform to the same CRS as the equal area grid
ea_occ <- terra::project(ea_occ, terra::crs(ea_raster))
## retransform into a data.frame
ea_occ <- data.frame(species = occ[, 1],
terra::crds(ea_occ))
colnames(ea_occ)[2:3] <- c("decimalLongitude","decimalLatitude")
# reproject gazetteers
## set the CRS in case it is not defined. Make sure to know the correct CRS.
terra::crs(gazetteers[[1]]) <-
terra::crs(gazetteers[[2]]) <-
wgs84
#transform to the new CRS
# ea_gaz <- lapply(gazetteers, terra::project,
# y = terra::crds(ea_raster))
ea_gaz <- lapply(gazetteers, function(g) terra::project(g, y = ea_raster))

# cit_ea <- project(gazetteers[[1]], terra::crs(ea_raster))
# roa_ea <- project(gazetteers[[2]], terra::crs(ea_raster))
# ea_gaz <- list(cities = cit_ea, roads = roa_ea)
# run sampbias

st_crs(ea_raster) == st_crs(ea_gaz[[1]])

ea_bias <- calculate_bias(x = ea_occ,
gaz = ea_gaz,
inp_raster = ea_raster)

plot(ea_bias)
ea_bias_proj <- project_bias(ea_bias)

sf::sf_use_s2(FALSE)
map_bias(ea_bias_proj, type="sampling_rate")
```



```{r}
model_bias_myg <- readRDS("output/sampling_bias/sampbias_mygals.rds")

plot(model_bias_myg)
```

getting sampling rate values as a raster

```{r}
bias_map <- readRDS("output/sampling_bias/samp_bias_map.rds")

sampling_rate <- bias_map$data |> 
  filter(split == "roads+cities+airports+waterbodies") |> 
  mutate(log_sr = log(val+1)) |>
  dplyr::select(-c(split, val))

sampling_rate_raster <- rast(sampling_rate)
crs(sampling_rate_raster) <- "EPSG:4326"
sampling_rate_raster_ea <- project(sampling_rate_raster, "EPSG:9473")

```

Mapping spatial sampling bias

```{r}
# need to do this within the same R session, i.e. entirely within job::job() as above, or entirely outside

# Project the bias effect in space
model_bias_myg_proj <- sampbias::project_bias(model_bias_myg)

# Map
sampbias::map_bias(model_bias_myg_proj, type="log_sampling_rate")
```

## Trialling different CRS and resolution
Making a map of Australia

```{r}
# map of Australia with states
aus_wgs84 <- st_transform(ozmaps::ozmap_states, "WGS84")

## check map
ggplot(aus_wgs84) + geom_sf(fill = "transparent")
```

modelling spatial sampling bias

```{r}
model_bias_myg_lower_res <- sampbias::calculate_bias(
  x = myg_spiders_spatial_bias,
  res = 0.5,   # scale of spatial resolution
  buffer = 0.5, # account for neighbouring features
  restrict_sample = sf:::as_Spatial(aus_wgs84)
)

plot(model_bias_myg_lower_res)

summary(model_bias_myg_lower_res)
```

Mapping occurrences and landscape features

```{r}
# Load in data for landscape features
data(airports)
data(waterbodies)
data(cities)
data(roads)


# Combine data
features <- c(airports, cities, waterbodies, roads)

# Convert to spatial features, set coordinate system, filter to within NT
# Add feature ID to each for plotting
features_sf <- features |>
  set_names(c("Airport", "City", "River", "Road")) |>
  map_dfr(~ st_as_sf(.) |> 
            st_set_crs(st_crs("WGS84")) |>
            st_intersection(aus_wgs84),
          .id = "feature")


# Plot all the points on a map alongside the features
features_map <- ggplot() +
  # NT map
  geom_sf(data = aus_wgs84,
          fill = "grey98", color = "grey40") +
  # Rivers & Roads
  geom_sf(data = features_sf |> filter(feature == "River" | feature == "Road"),
          mapping = aes(color = feature),
          size = 1.1,
          show.legend = "line") +
  # Airports
  geom_sf(data = features_sf |> filter(feature == "Airport" ),
          mapping = aes(color = feature),
          shape = 17,
          size = 6,
          show.legend = "point") +
  # Cities
  geom_sf(data = features_sf |> filter(feature == "City"),
          mapping = aes(color = feature),
          shape = 16,
          size = 4,
          show.legend = "point") +
  # Observations
  geom_point(data = myg_spiders_spatial_bias,
             mapping = aes(x = decimalLongitude, y = decimalLatitude),
             color = "#E06E53",
             size = 1.1,
             alpha = 0.3) +
  # Specify colours
  scale_color_manual(values = c(
    "River" = "#249db5",
    "Road" = "#ffc517",
    "Airport" = "#9956db",
    "City" = "#30c788"
  ),
  # Create custom line/point legend
  guide = guide_legend(
    override.aes = list(linetype = c("solid", "solid", "blank", "blank"), 
                        shape = c(NA, NA, 17, 16),
                        size = c(1.1, 1.1, 6, 4)),
    title = NULL)) +
  theme_void() +
  theme(legend.position = "bottom")
```

Mapping spatial sampling bias

```{r}
# Project the bias effect in space
model_bias_myg_lower_res_proj <- sampbias::project_bias(model_bias_myg_lower_res)

# Map
sampbias::map_bias(model_bias_myg_lower_res_proj, type="log_sampling_rate")
```