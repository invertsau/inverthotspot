---
title: "Spatial bias"
author: "Josh Nitschke"
date: "2024-04-06"
output: 
  rmdformats::downcute:
    self_contained: true
    toc_depth: 3
editor_options: 
  chunk_output_type: console
---

<style>
#toc ul.nav li ul li {
    display: none;
    max-height: none;
}

#toc ul.nav li.active ul li  {
    display: block;
    max-height: none;
}

#toc ul.nav li ul li ul li {
    max-height: none;
    display: none !important;
}

#toc ul.nav li ul li.active ul li {
    max-height: none;
    display: block !important;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loadpackages, include=FALSE}
## Setting up

# install.packages("pacman")
pacman::p_load(galah, arrow, here, tidyverse, janitor, ozmaps, sf, ggplot2, wesanderson, dplyr, DT, sampbias, viridis, rnaturalearthdata)

# Load helper functions
source(here("R/utils.R"))

## Read in parquet
myg_spiders_all <- open_dataset(here(get_latest_download()))

## Subset columns we want for ALA data overview
myg_spiders_spatial_bias <- myg_spiders_all |> 
  select(species, decimalLatitude, decimalLongitude, recordID) |> 
  collect()
```

# Spatial sampling bias for Mygalomorphae

Making a map of Australia

```{r}
# map of Australia with states
aus <- st_transform(ozmaps::ozmap_states, 4326)

## check map
ggplot(aus) + geom_sf(fill = "transparent")
```

modelling spatial sampling bias

```{r}
model_bias_myg <- sampbias::calculate_bias(
  x = myg_spiders_spatial_bias,
  res = 0.05,   # scale of spatial resolution
  buffer = 0.5, # account for neighbouring features
  restrict_sample = sf:::as_Spatial(aus)
)

plot(model_bias_myg)
```

Mapping spatial sampling bias

```{r}
# Project the bias effect in space
model_bias_myg_proj <- sampbias::project_bias(model_bias_myg)

# Map
sampbias::map_bias(model_bias_myg_proj, type="log_sampling_rate")
```

## Trialling different CRS and resolution
Making a map of Australia

```{r}
# map of Australia with states
aus_wgs84 <- st_transform(ozmaps::ozmap_states, "WGS84")

## check map
ggplot(aus_wgs84) + geom_sf(fill = "transparent")
```

modelling spatial sampling bias

```{r}
model_bias_myg_lower_res <- sampbias::calculate_bias(
  x = myg_spiders_spatial_bias,
  res = 0.5,   # scale of spatial resolution
  buffer = 0.5, # account for neighbouring features
  restrict_sample = sf:::as_Spatial(aus_wgs84)
)

plot(model_bias_myg_lower_res)
```

Mapping spatial sampling bias

```{r}
# Project the bias effect in space
model_bias_myg_lower_res_proj <- sampbias::project_bias(model_bias_myg_lower_res)

# Map
sampbias::map_bias(model_bias_myg_lower_res_proj, type="log_sampling_rate")
```