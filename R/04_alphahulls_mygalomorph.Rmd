---
title: "Alpha hulls"
author: "Fonti Kar and Payal Bal"
date: "2023-08-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loadpackages}
# Install the package
#install.packages("remotes")
# remotes::install_github("beatrizpateiro/alphahull", ref="WIP-ahull.IUCN-feature")
# remotes::install_github("babichmorrowc/hull2spatial")

# Load packages
#install.packages("pacman")
pacman::p_load(galah, arrow, here, tidyverse, ozmaps, sf, ggplot2, skimr, alphahull, hull2spatial, sp, purrr, ConR, dplyr)

source("R/utils.R")
```

## Read in data

```{r}
get_latest_cleaned_data()

myg_spiders_cleaned <- read_parquet(get_latest_cleaned_data())
```

## Proof of concept

Selecting a random taxa to create alphahulls, so we can abstract the workflow to all taxa

```{r}
set.seed(987)
choosen <- myg_spiders_cleaned |> 
  slice_sample(n = 1) |> 
  pull(scientificName)

b_aurea <- myg_spiders_cleaned |> 
  filter(scientificName == choosen)

b_aurea |> skim()
```

### A quick overview of observations

Make a simple map

```{r}
# Transform projection
aus <- st_transform(ozmaps::ozmap_country, 4326)

# Base map 
base_map <- ggplot() + 
  geom_sf(data = aus, fill = "white") + 
  theme_minimal()

# Transform spiders into sf objects
b_aurea_sf <- b_aurea |> 
  select(scientificName, decimalLongitude, decimalLatitude) |> 
  st_as_sf(coords = c("decimalLongitude", "decimalLatitude"), 
           crs = 4326)

# Base map 
base_map  + 
  geom_sf(data = b_aurea_sf, alpha = 0.5) + 
  theme_minimal()
```

## Create an alpha hull

Alpha hulls are a flexible way to represent species distributions without all the extra work of running a species distribution model. 

### ConR

#### Proof of concept for one sp 

```{r}
b_aurea 

# Reshuffle data according to documentation requirements
b_aurea_conr <- b_aurea |> 
  dplyr::select(decimalLatitude, decimalLongitude, scientificName)

conr_output <- EOO.computing(b_aurea_conr, 
                             method.range = "alpha",
                             alpha = 2, 
                             buff.alpha = 0.000001,
                             export_shp = TRUE,
                             write_shp = TRUE)

as(conr_output$spatial, "Spatial")
```

#### Extrapolate to all Myg taxa

```{r}
# A function to generate alpha-hull and extract output and transform into sf object
ConR_ahull <- function(data, sf_transform = TRUE){

  conr_output <- ConR::EOO.computing(data, 
                               method.range = "alpha",
                               alpha = 2, 
                               buff.alpha = 0.000001,
                               export_shp = TRUE)
  if(sf_transform == TRUE){
  as(conr_output$spatial, "Spatial")
  } 
  else
    conr_output$spatial
}

# Nest data
myg_conr_nest <- myg_spiders_cleaned |> 
  dplyr::select(decimalLatitude, decimalLongitude, scientificName) |> 
  mutate(species = scientificName) |> 
  nest(occ = c(starts_with("decimal"), scientificName))

# Test function on one
ConR_ahull(myg_conr_nest$occ[[1]], sf_transform = TRUE)

# Iterative across list 
spider_list <- myg_spiders_cleaned |> 
  dplyr::select(decimalLatitude, decimalLongitude, scientificName) |> 
  split(~scientificName)

myg_conr_nest$conr_ahull <- lapply(spider_list, ConR_ahull, sf_transform = TRUE)

# A function to map over
# Can't get this map working for some reason! 
# myg_conr_nest |> 
#   mutate(conr_ahull = map(.x = occ, 
#                           ~ConR_ahull(.x, st_transform = TRUE))
#   )
#   

# Save spatial dataframe
write_rds(myg_conr_nest$conr_ahull, here("output/spatial/clean_myg_concr_output.rds"))

myg_concr_output <- read_rds(here("output/myg_concr_output.rds"))

# Flatten output
myg_concr_output <- myg_concr_output |> flatten() 

# Need a mechanism to name the list
myg_concr_output[[1]]$Results |> names()

length(myg_concr_output) == nrow(myg_conr_nest)

names(myg_concr_output) <- myg_conr_nest$species

myg_concr_output

# Extract spatialPoly_EOO only for endemism workflow
get_EOO_sp <- function(sp_name){
  output <- myg_concr_output |> 
  pluck(sp_name, "spatialPoly_EOO") 
}

myg_spiders_conr_sp <- map(.x = myg_conr_nest$species,
     ~get_EOO_sp(.x))

length(myg_spiders_conr_sp) == nrow(myg_conr_nest)

names(myg_spiders_conr_sp) <- myg_conr_nest$species

write_rds(myg_spiders_conr_sp, "output/myg_spiders_conr_sp.rds")


# A function to pull spatialPoly_EOO, change it to sf and add in species name
get_ahull_sf <- function(sp_name){
  output <- myg_concr_output |> 
  pluck(sp_name, "spatialPoly_EOO")  |> 
  st_as_sf() |> 
  mutate(species = sp_name) |> 
  dplyr::select(-dummy) 
  
  row.names(output) <- NULL
  
  output
}

myg_spiders_conr_sf <- map_df(.x = myg_conr_nest$species,
     ~get_ahull_sf(.x))

write_rds(myg_spiders_conr_sf, "output/myg_sf_alphahulls.rds")
```

### Plot these all at once

```{r}
myg_spiders_conr_sf <- readRDS("output/myg_sf_alphahulls.rds")

base_map + # There are offshore points need to crop these
  geom_sf(data = myg_spiders_conr_sf, aes(geometry = geometry), fill = "#023E50",
          alpha = 0.1) +
  coord_sf(ylim=c(-10,-45),
         xlim=c(113,155)) + 
  theme_minimal()

base_map + # There are offshore points need to crop these
    geom_sf(data = myg_hull_plot, aes(geometry = points), colour = "black", 
              alpha = 0.2) + 
  geom_sf(data = myg_hull_plot, aes(geometry = geometry, fill = family),
          alpha = 0.01) +
  guides(fill = guide_legend(override.aes = list(alpha = 0.5))) + 
  coord_sf(ylim=c(-10,-45),
         xlim=c(113,155)) + 
  theme(legend.position = "bottom")
```

A few example taxa

```{r}
test <- myg_spiders_conr_sf |>  
  sample_frac(0.2) 

test
test_occ <- myg_conr_nest |> 
  filter(species %in% test$species) |> 
  unnest() |> 
  dplyr::select(-scientificName) |> 
  st_as_sf(crs = 4326, coords = c("decimalLongitude", "decimalLatitude")) 


base_map + # There are offshore points need to crop these
  geom_sf(data = test, aes(geometry = geometry), fill = "#023E50",
          alpha = 0.2) +
  geom_sf(data = test_occ, size = 0.2, colour = "deepskyblue2") +
  coord_sf(ylim=c(-10,-45),
         xlim=c(113,155)) + 
  theme_minimal()
```
 
devtools::install_github("gdauby/ConR")

myg_spiders <- read_parquet(here("data/galah/Mygalomorphae_withassertions_2023-09-18_ALA.parquet"))



dataset <- dummy_dist(nsp = 1, max_occ = 30)

alphas <- EOO.computing(XY = dataset, method.range = "alpha", export_shp = TRUE, alpha = 3)

plot(alphas$spatial)

alphas <- EOO.computing(XY = dataset, method.range = "alpha", export_shp = TRUE, alpha = 3, buff.alpha = 	0.000001)

plot(alphas$spatial)


