---
title: "ALA Data Retrieval"
author: "Fonti Kar and Ashley Browse"
date: "2023-07-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Accessing data from ALA

This document lays out the workflow of getting data for Mygalomorph spiders from the ALA database 

## Load dependencies

```{r loadpackages}
install.packages("pacman")
pacman::p_load(galah, arrow, usethis, tidyverse, janitor)
```

## Account Registration and {galah} Configuration 

Before downloading data from ALA, we need an email registered with ALA. We can then download ALA occurrence data, filtering to within Australia and using ALA's data cleaning filters.

```{r}
# Add ALA registered email to access data (register at ala.org.au)
edit_r_environ()
# Paste in R environment ALA_EMAIL="your.email@email.com"

# Retrieve email (secretly)
Sys.getenv("ALA_EMAIL")

# Configure galah
galah_config(email = Sys.getenv("ALA_EMAIL"), 
             atlas = "Australia")
```

## Download data

### Assertions

We will exclude any records that are flagged `identificationIncorrect == TRUE`

```{r}
# Ashley can you add in code here for downloading assertions and saving them output/ please?

```

### Which data variables do we want from galah?

<!-- AB to check with PB which columns we need  -->
Higher taxonomy e.g. family, class, genus
State information (NSW, NT, TAS, WA, SA, QLD, ACT, VIC)

```{r}
show_all_fields() |> 
  print(n = Inf)

fields_we_want <- c("phylum", "class",  "order", "family",  "genus", "species", "taxonRank",
  "raw_scientificName", "raw_vernacularName", 
  "stateProvince", "locality", "coordinatePrecision",  "coordinateUncertaintyInMeters", "decimalLatitude", "decimalLongitude",
  "basisOfRecord", "institutionCode", "datasetName", "collectionCode")
```

### Submit query to ALA

```{r}
mygalomorphae_occurrences <- 
  galah_call() |>                               
  galah_identify("Mygalomorphae") |>   
  #galah_filter(identificationIncorrect == FALSE) |> 
  galah_select(group = c("basic"), all_of(fields_we_want)) |> 
  atlas_occurrences() 
  #atlas_counts()

mygalomorphae_assertions <- 
  galah_call() |>                               
  galah_identify("Mygalomorphae") |>   
  #galah_filter(identificationIncorrect == FALSE) |> 
  galah_select(group = c("assertions")) |> 
  atlas_occurrences() 
  #atlas_counts()
```

### Join the assertions and occurrence together

```{r}
mygalomorphae_occurrences |> names()
mygalomorphae_occurrences |> nrow()

mygalomorphae_assertions |> names()
mygalomorphae_assertions |> nrow()

joined_data <- left_join(mygalomorphae_occurrences, mygalomorphae_assertions, by = "recordID")
```

### Save downloaded data

Save the downloaded data as a `.parquet`

```{r}
write_parquet(joined_data, paste0("data/galah/Mygalomorphae_withassertions", Sys.Date(), "_ALA.paraquet"))
```





